<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>ECS migrate to EKS part 3 - Rico-Blog</title><meta name=description content="AWS CDK EKS package experience"><meta name=author content="Rico Chen"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"Rico-Blog","url":"https:\/\/blog.rico.ninja"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/blog.rico.ninja"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/blog.rico.ninja","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/blog.rico.ninja\/post\/tech\/ecs-to-eks-3\/","name":"E c s migrate to e k s part 3"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"Rico"},"headline":"ECS migrate to EKS part 3","description":"AWS CDK EKS package experience","inLanguage":"en","wordCount":1477,"datePublished":"2020-10-20T00:00:00","dateModified":"2020-10-20T00:00:00","image":"https:\/\/blog.rico.ninja\/avatar.png","keywords":["eks, cdk, kubernetes, aws"],"mainEntityOfPage":"https:\/\/blog.rico.ninja\/post\/tech\/ecs-to-eks-3\/","publisher":{"@type":"Organization","name":"https:\/\/blog.rico.ninja","logo":{"@type":"ImageObject","url":"https:\/\/blog.rico.ninja\/avatar.png","height":60,"width":60}}}</script><meta property="og:title" content="ECS migrate to EKS part 3"><meta property="og:description" content="AWS CDK EKS package experience"><meta property="og:image" content="https://blog.rico.ninja/avatar.png"><meta property="og:url" content="https://blog.rico.ninja/post/tech/ecs-to-eks-3/"><meta property="og:type" content="website"><meta property="og:site_name" content="Rico-Blog"><meta name=twitter:title content="ECS migrate to EKS part 3"><meta name=twitter:description content="AWS CDK EKS package experience"><meta name=twitter:image content="https://blog.rico.ninja/avatar.png"><meta name=twitter:card content="summary"><meta name=twitter:site content="@RicoChenNinja"><meta name=twitter:creator content="@RicoChenNinja"><link href=https://blog.rico.ninja/img/favicon.ico rel=icon type=image/x-icon><meta name=generator content="Hugo 0.76.4"><link rel=alternate href=https://blog.rico.ninja/index.xml type=application/rss+xml title=Rico-Blog><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://blog.rico.ninja/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://blog.rico.ninja/css/highlight.min.css><link rel=stylesheet href=https://blog.rico.ninja/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-143962684-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class=navbar-brand href=https://blog.rico.ninja>Rico-Blog</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=Home href=/>Home</a></li><li><a title="About Me" href=/about/>About Me</a></li><li><a title=Categories href=/categories>Categories</a></li><li><a title=Tags href=/tags>Tags</a></li></ul></div><div class=avatar-container><div class=avatar-img-border><a title=Rico-Blog href=https://blog.rico.ninja><img class=avatar-img src=https://blog.rico.ninja/avatar.png alt=Rico-Blog></a></div></div></div></nav><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><h1>ECS migrate to EKS part 3</h1><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on October 20, 2020
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;3&nbsp;minutes
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;1477&nbsp;words
&nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Rico</span></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><h1 id=how-to-start-your-aws-cdk-journey>How to start your AWS CDK journey?</h1><p>在台灣 <a href=https://cdkmeetup.kktix.cc/events/fristmeetup>AWS CDK meetup#1</a> 裡有分享過<a href=https://speakerdeck.com/ricotoothless/taiwan-cdk-meetup-rookie-operators-cdk-journey>新手 operator 寫 CDK 之旅</a>（建議把整個 PDF 下載下來，裡面有很多連結），初學者怎麼入門後快速熟悉整個 CDK 生態圈，最近 AWS 在全球非常積極推動 CDK，各個關於 CDK 的分享或資源真的全世界各個國家都有，裡面的資源可以陪伴新手從初級到進階都沒問題。</p><h1 id=aws-cdk-eks-overview>AWS CDK EKS Overview</h1><p>AWS CDK 把每一個 AWS 服務包成一個 package，每一個 package 成熟度不一，像是 AWS CDK EKS 就還在 experiment 階段，也曾經因為 CDK EKS 有非常大的 breaking change，不得不重新創一個新的 EKS cluster，並且把所有的 application migrate 過去。最近 EKS 的功能越來越齊全了，像是可以創建 IRSA（IAM Roles for Service Accounts）的 Service Account 之外，還會把 OIDC ID provider 自動創建起來，非常地方便。實際建置時 EKS 除了 application CICD 是用 Jenkins 做之外，像是 backing services、monitoring 的建置，還有 backing services 本身、monitoring 與 application 本身的 IRSA 都是靠 CDK 建置的。例如：<a href=https://learn.hashicorp.com/tutorials/vault/autounseal-aws-kms>Hashicorp Vault KMS Auto-Unseal</a> 會需要 AWS KMS 的權限來調用 KMS 做為 Vault Master Key 來加解密敏感資料。</p><h2 id=aws-cdk-eks-helm-chart-management>AWS CDK EKS Helm Chart management</h2><p>Kubernetes 使用者對於 Helm 的使用率還是非常地高，建置服務的時候可以大幅縮短自己造輪子的時間，想當初建置一個 rabbitmq cluster、redis sentinel 或者 vault 等等都要在不彈性的 ECS 上建置，就會覺得有類似於 package manager 功能的工具是非常需要的。也因此，CDK EKS 有支援 Helm 的確不太意外，但在實際上使用的時候會發現有客製 chart repository server 的需求，就要小心不要遇到雞生蛋蛋生雞的問題，例如把 chart repository 放在 <a href=https://www.sonatype.com/nexus/repository-oss>Nexus</a> 裡，然後 Nexus 是透過 ingress controller 代理的，又剛好這個 ingress controller 是客製化的 chart，就有可能會變成在 CDK deploy 的時候因為 ingress 沒有啟動而抓不到 Nexus server 裡面的 chart。所以這裡的建議是放在 ECR or S3 會比較好一點，做法就是一樣用 CDK 建置 chart repository 專用的 repository or Bucket 之後，chart 再從 source control 出發開始跑 CICD 最後到 chart repository 裡，最後 CDK EKS helm chart 再從 chart repository 裡 pull 我們客製化過的 chart。</p><h2 id=aws-cdk-kubernetes-resources-management>AWS CDK Kubernetes resources management</h2><p>AWS CDK EKS 在 Kubernet resource management 歷史比較久而且變化一直都蠻大的，最一開始只有用 <code>kubectl apply</code> 來實踐 Kubernetes resource 的創建或修改，對我而言其實算夠用了，畢竟大部分的 services 都是靠 Helm 管理，只有少部分的 resources 像是 PV、PVC 或 storageClass 需要額外管理。在最近的 CDK 版本中，多了一個新的 <a href=https://github.com/awslabs/cdk8s>CDK8s</a> 的選擇之外，CDK EKS 本身也多了 query 的概念，像是在<a href=https://docs.aws.amazon.com/cdk/api/latest/python/aws_cdk.aws_eks.README.html#id11>官方文件</a>中的案例為抓取已經建立好的 LoadBalancer DNS name，我自己本身也是使用 LoadBalancer 想說希望有 query 的功能，但山不轉路轉，我後來是選擇使用 <a href=https://github.com/kubernetes-sigs/external-dns>external-dns</a> 做為 service discovery 的工具。</p><h2 id=eks-ingress-solution-traefik-v17--alb>EKS ingress solution: Traefik (v1.7) + ALB</h2><p>對於 ingress 的實踐相對複雜一點，原本是使用 Traefik (v1.7) + Network Load Balancer，但面對複雜的 routing 需求再加上想要與 AWS resources 有更好地整合，像是可以直接套用 <a href=https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/ingress/annotation/#wafv2>WAF</a>、<a href=https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/ingress/annotation/#ssl>ACM</a> 或 <a href=https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/ingress/annotation/#access-control>Security Group</a> 等等。後來有想導入 AWS ALB controller 來替 ingress 加上 ALB，但現實上遇到的問題就是走 microservices 要替每一個 ingress 建立一個 ALB 的話不太符合經濟效益。所以最後的做法是 Traefik (v1.7) + ALB，關於怎麼運作的流程圖：</p><p><img src=/traefik-alb.png alt=traefik-alb.png></p><blockquote><p>在公開的 <a href=https://github.com/helm/charts/tree/master/stable/traefik>Helm charts stable</a> 裡，最多只有到 service，並沒有 ingress object，所以要能夠使用這個架構必須自己客製 chart。</p></blockquote><p>流程大致如下：</p><ol><li>使用 <a href=https://github.com/helm/charts/tree/master/incubator/aws-alb-ingress-controller>Helm charts incubator aws-alb-ingress-controller</a> 建置 ALB controller，並且額外建立 service account for IRSA</li><li>使用客製的 Traefik chart，透過 ingress object 讓 ALB controller 知道要建立 Traefik 專屬的 ALB</li><li>建立想要讓外面流量可以訪問的 application，透過 ingress object 讓 Traefik 知道要建立 routing rule</li><li>當一般的 user 做訪問的時候會先從 ALB 進來到 Traefik service，再來是 Traefik pods，之後 Traefik 會把 application 的行為傳回 user</li></ol><h1 id=conclusion>Conclusion</h1><ul><li>CDK package 每個成熟度不一，依照公司可以承擔的風險做選擇</li><li>CDK EKS package 在 experiment 中，但依舊有很多好用的功能像是 IRSA、Helm 或進階的 Kubernetes resources management</li><li>自建的 chart repository 要避免落入雞生蛋蛋生雞的情境</li><li>CDK EKS 對 Kubernetes resources 除了 create or modify 之外，新增了 query 的功能</li><li>設計系統的過程中要適時的山不轉路轉</li><li>Traefik + ALB 可以讓 routing 做更多的變化，與 AWS resources 有更好地整合</li></ul><h1 id=reference>Reference</h1><ul><li><a href=https://aws.amazon.com/blogs/opensource/introducing-fine-grained-iam-roles-service-accounts/>Introducing fine-grained IAM roles for service accounts</a></li><li><a href=https://12factor.net/backing-services>Backing services</a></li><li><a href=https://doc.traefik.io/traefik/v1.7/user-guide/kubernetes/>Traefik Kubernetes User Guide</a></li><li><a href=https://kubernetes-sigs.github.io/aws-alb-ingress-controller/>AWS ALB Ingress Controller¶</a></li></ul><div class=blog-tags><a href=https://blog.rico.ninja/tags/eks/>eks</a>&nbsp;
<a href=https://blog.rico.ninja/tags/cdk/>cdk</a>&nbsp;
<a href=https://blog.rico.ninja/tags/kubernetes/>kubernetes</a>&nbsp;
<a href=https://blog.rico.ninja/tags/aws/>aws</a>&nbsp;</div><hr><section id=social-share><div class="list-inline footer-links"><div class=share-box aria-hidden=true><ul class=share><li><a href="//twitter.com/share?url=https%3a%2f%2fblog.rico.ninja%2fpost%2ftech%2fecs-to-eks-3%2f&text=ECS%20migrate%20to%20EKS%20part%203&via=RicoChenNinja" target=_blank title="Share on Twitter"><i class="fab fa-twitter"></i></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.rico.ninja%2fpost%2ftech%2fecs-to-eks-3%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook"></i></a></li><li><a href="//reddit.com/submit?url=https%3a%2f%2fblog.rico.ninja%2fpost%2ftech%2fecs-to-eks-3%2f&title=ECS%20migrate%20to%20EKS%20part%203" target=_blank title="Share on Reddit"><i class="fab fa-reddit"></i></a></li><li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fblog.rico.ninja%2fpost%2ftech%2fecs-to-eks-3%2f&title=ECS%20migrate%20to%20EKS%20part%203" target=_blank title="Share on LinkedIn"><i class="fab fa-linkedin"></i></a></li><li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fblog.rico.ninja%2fpost%2ftech%2fecs-to-eks-3%2f&title=ECS%20migrate%20to%20EKS%20part%203" target=_blank title="Share on StumbleUpon"><i class="fab fa-stumbleupon"></i></a></li><li><a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fblog.rico.ninja%2fpost%2ftech%2fecs-to-eks-3%2f&description=ECS%20migrate%20to%20EKS%20part%203" target=_blank title="Share on Pinterest"><i class="fab fa-pinterest"></i></a></li></ul></div></div></section><h4 class=see-also>See also</h4><ul><li><a href=/post/tech/vault-ethereum/>Vault Ethereum Plugin</a></li><li><a href=/post/tech/aws-cdk-cross-reference/>AWS CDK cross-reference</a></li><li><a href=/post/tech/ecs-to-eks-2/>ECS migrate to EKS part 2</a></li><li><a href=/post/tech/ecs-to-eks-1/>ECS migrate to EKS part 1</a></li></ul></article><ul class="pager blog-pager"><li class=previous><a href=https://blog.rico.ninja/post/tech/ecs-to-eks-2/ data-toggle=tooltip data-placement=top title="ECS migrate to EKS part 2">&larr; Previous Post</a></li><li class=next><a href=https://blog.rico.ninja/post/life/geforce-now/ data-toggle=tooltip data-placement=top title="GeForce NOW quick look">Next Post &rarr;</a></li></ul><div class=disqus-comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"rico-blog"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=mailto:rico3452@gmail.com title="Email me"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://github.com/RicoToothless title=GitHub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://twitter.com/RicoChenNinja title=Twitter><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fab fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://linkedin.com/in/rico-chen-devops title=LinkedIn><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://stackoverflow.com/users/10285171/ricochen title=StackOverflow><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted"><a href=blog.rico.ninja>Rico Chen</a>
&nbsp;&bull;&nbsp;&copy;
2022
&nbsp;&bull;&nbsp;
<a href=https://blog.rico.ninja>Rico-Blog</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.76.4</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous></script><script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script src=https://blog.rico.ninja/js/main.js></script><script src=https://blog.rico.ninja/js/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script><script>$(document).ready(function(){$("pre.chroma").css("padding","0");});</script><script>renderMathInElement(document.body);</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://blog.rico.ninja/js/load-photoswipe.js></script></body></html>