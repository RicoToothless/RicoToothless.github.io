<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Vault Ethereum Plugin - Rico-Blog</title><meta name=description content="The Hashicorp Vault plugin for Ethereum wallet"><meta name=author content="Rico Chen"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"Rico-Blog","url":"https:\/\/blog.rico.ninja"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/blog.rico.ninja"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/blog.rico.ninja","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/blog.rico.ninja\/post\/tech\/vault-ethereum\/","name":"Vault ethereum plugin"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"Rico"},"headline":"Vault Ethereum Plugin","description":"The Hashicorp Vault plugin for Ethereum wallet","inLanguage":"en","wordCount":1673,"datePublished":"2021-12-24T00:00:00","dateModified":"2021-12-24T00:00:00","image":"https:\/\/blog.rico.ninja\/avatar.png","keywords":["hashicorp, vault, ethereum, container, kubernetes, remote-signer"],"mainEntityOfPage":"https:\/\/blog.rico.ninja\/post\/tech\/vault-ethereum\/","publisher":{"@type":"Organization","name":"https:\/\/blog.rico.ninja","logo":{"@type":"ImageObject","url":"https:\/\/blog.rico.ninja\/avatar.png","height":60,"width":60}}}</script><meta property="og:title" content="Vault Ethereum Plugin"><meta property="og:description" content="The Hashicorp Vault plugin for Ethereum wallet"><meta property="og:image" content="https://blog.rico.ninja/avatar.png"><meta property="og:url" content="https://blog.rico.ninja/post/tech/vault-ethereum/"><meta property="og:type" content="website"><meta property="og:site_name" content="Rico-Blog"><meta name=twitter:title content="Vault Ethereum Plugin"><meta name=twitter:description content="The Hashicorp Vault plugin for Ethereum wallet"><meta name=twitter:image content="https://blog.rico.ninja/avatar.png"><meta name=twitter:card content="summary"><meta name=twitter:site content="@RicoChenNinja"><meta name=twitter:creator content="@RicoChenNinja"><link href=https://blog.rico.ninja/img/favicon.ico rel=icon type=image/x-icon><meta name=generator content="Hugo 0.76.4"><link rel=alternate href=https://blog.rico.ninja/index.xml type=application/rss+xml title=Rico-Blog><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://blog.rico.ninja/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://blog.rico.ninja/css/highlight.min.css><link rel=stylesheet href=https://blog.rico.ninja/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-143962684-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class=navbar-brand href=https://blog.rico.ninja>Rico-Blog</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=Home href=/>Home</a></li><li><a title="About Me" href=/about/>About Me</a></li><li><a title=Categories href=/categories>Categories</a></li><li><a title=Tags href=/tags>Tags</a></li></ul></div><div class=avatar-container><div class=avatar-img-border><a title=Rico-Blog href=https://blog.rico.ninja><img class=avatar-img src=https://blog.rico.ninja/avatar.png alt=Rico-Blog></a></div></div></div></nav><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><h1>Vault Ethereum Plugin</h1><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on December 24, 2021
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;4&nbsp;minutes
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;1673&nbsp;words
&nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Rico</span></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><p><img src=/vault-ethereum-opening.png alt=vault-ethereum-opening></p><h2 id=what-is-hashicorp-vault>What is Hashicorp Vault?</h2><p>在介紹最核心的 plugin 之前還是要講一下這個工具的背景，由 <a href=https://www.hashicorp.com/>Hashicorp</a> 公司開發的產品 <a href=https://www.vaultproject.io/>Vault</a>，Vault 專門管理任何敏感的資料，而且用法非常非常多元。從常見的儲存 key value 的敏感資料外，動態生產臨時用的敏感資料也算，例如，生產臨時的 AWS IAM、資料庫 username & password、生產 TLS 給 cert-manager 等等，除了內建的使用方法外，Vault 也支援 <a href=https://www.vaultproject.io/docs/internals/plugins>plugin 系統</a>，使用者可以寫自己的邏輯在裡面。</p><p>Vault plugin 跟 Vault 本身是兩支不同且獨立的程式，為了資安考量，plugin 並沒有跟 Vault 使用相同的記憶體，兩支程式溝通是靠 TLS 加密過，如上所述，plugin 壞了也不會影響 Vault 本身的運作。</p><h2 id=why-vault-ethereum-plugin>Why Vault Ethereum plugin?</h2><p>在進入正題前要先跟大家講一下背景，區塊鏈錢包傳統上是架設一台完整的節點機器，然後在節點機器上創建錢包，錢包的操作都靠這台節點完成。</p><p>沒有意外的話錢包的操作不會對外開放，一定得進去機器才做操作。但問題就來了，只要駭客能進到這機器和有 account password 就可以操作錢包，另外假如今天要管理多台節點該怎麼有效管理？假如我今天要管理大量的錢包要如何保證其安全？</p><p>於是乎，有多種 remote signer 的工具給大家選擇，簡單來說就是把節點跟錢包拆開來管理。每一種 remote signer 工具的流程都不太一樣，有些是先問 remote signer 再問節點，例如這次介紹的 Vault Ethereum plugin；有些是先問節點再問 remote signer，例如 <a href=https://github.com/ethereum/go-ethereum/tree/master/cmd/clef#security-model>Clef</a>。</p><p>不可否認的是，remote signer 是很進階的工具，雖然 remote signer 會把 private keys 加密過放在硬碟裡、放在外部的 cloud provider SaaS 或者 HSM 裝置裡，但是要怎麼規劃網路，還有誰可以使用都必須好好設計。</p><hr><p>Vault Ethereum plugin 作者為美國 Washington, D.C. 和 Baltimore 地區的 HashiCorp User Group 創辦人 Jeff Ploughman 在<a href=https://www.hashicorp.com/blog/using-vault-to-build-an-ethereum-wallet>這篇文章</a>認為：</p><p>雖然使用錢包時是基於密碼學之上，而 public key 可以當作分散式的概念分享給其他人，但 private key 本質上是中心化的概念，因為此概念跟區塊鏈分散式的思想背道而馳，讓作者常常不經思考錢包並不是跟區塊鏈的概念一起設計的，反而像是區塊鏈另外加裝一個錢包功能的 sidecar（白話一點就是作者覺得錢包設計沒有很優秀），這也讓很多大型企業在管理錢包的時候傷透腦筋。</p><p>所以作者倚賴 Hashicorp Vault，因為此工具已經提供很多安全的機制，例如文章裡面示範了 Vault 本身的 seal 機制、application 或是使用者身份驗證、MFA 和支援 HSM（需要 Vault Enterprise 才有），當然我個人最看重的還是 <a href=https://www.vaultproject.io/docs/auth>Auth Methods</a> 、<a href=https://www.vaultproject.io/docs/concepts/policies>Policy</a> 和 <a href=https://www.vaultproject.io/docs/audit>Audit</a> 的機制，這樣可以在眾多使用者或程式當中誰可以存取哪些 private key、只授權能做特定的操作最後追蹤特定的時間點發生什麼事。</p><p>文章也提到可以拿來串 Github MFA authentication 做 CICD pipeline 來部署 smart contract，當然這還是得看 gas price 現在行情如何。</p><p>作者也有受邀到 2018 年的 <a href=https://youtu.be/nIez8LXtefY>HachiCon 演講</a>，他最後有示範 cold storage 加上 MFA 送 20 美金給觀眾。</p><h2 id=vault-ethereum-plugin-usage>Vault Ethereum plugin usage</h2><p><a href=https://github.com/immutability-io/vault-ethereum>Vault-Ethereum Plugin</a> 專案的 README 已經有個快速的 demo 展示其主要功能，簡單來說他會在 docker-compose 裡創建兩個服務，一個是 vault 一個是 ganache（ganache 是用來個人測試的 Ethereum node，很多測試的功能會預先替使用者準備好）。</p><p><img src=/vault-ethereum-architecture.png alt=vault-ethereum-architecture></p><p>作者建議把專案放在 <code>GOPATH</code> 下，但其實如果只是純粹用 docker-compose 的話其實可以不用。一開始會自己客製 container image 後啟動 docker-compose 環境。</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ cd $GOPATH/src/github.com/immutability-io/vault-ethereum
$ make docker-build
$ make run
</code></pre></div><p>打開另外一個 console 或 terminal 後到專案的 <code>docker/</code> 目錄下執行 vault 的身份驗證，之後我們就可以對 Vault 打出一系列的請求了。</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ cd $GOPATH/src/github.com/immutability-io/vault-ethereum/docker

# Authenticate
$ source ./local-test.sh auth
$ ./demo.sh &gt; README.md
</code></pre></div><p>全部的請求有：</p><ol><li>以 mnemonic 匯入 account</li><li>直接創新的 account</li><li>查詢 ETH 餘額</li><li>轉錢</li><li>簽名</li><li>部署 smart contract</li><li>查看 smart contract 的 token 餘額</li></ol><p>跑完指令後就可以看到執行的結果了，可以從 <a href=https://github.com/immutability-io/vault-ethereum/blob/master/docker/README-demo.md>docker/README-demo.md</a> 參考他要請求的範例。</p><hr><p>我實際安裝的時候發現一些情況跟大家分享一下。</p><p>先前提到 Vault plugin 架構是 plugin 這個程式是完全跟 Vault 主程式分開，所以 plugin 得靠 <code>api_addr</code> 這個設定去互動，其實有點綁手綁腳，所以在設計的時候要注意。</p><p>另外 Vault plugin 不比 Terraform plugin 生態系來得豐富，所以網路上的資源相對少蠻多的。</p><p>還有 Vault plugin error message 蠻難判斷到底發生什麼問題，例如 plugin binary 檔案沒有執行權限的話只會噴很摸不著頭緒的 error。</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>Unrecognized remote plugin message: 

This usually means that the plugin is either invalid or simply
needs to be recompiled to support the latest protocol.
</code></pre></div><p>還有需要注意的是，Vault Ethereum plugin 沒有釋出 Alpine Linux binary，所以無法透過 Vault 官方 image 直接下載 plugin binary，要自己客製 container image。</p><h2 id=conclusion>Conclusion</h2><ul><li>管理敏感資訊一直都很難，到哪裡都一樣</li><li>Vault Ethereum plugin 倚賴 Vault 本身提供的安全功能來保護錢包安全</li><li>Vault Ethereum plugin 涵蓋幾乎所有的鏈上鏈下操作</li><li>Vault plugin 生態系並沒有十分活躍</li></ul><h2 id=reference>Reference</h2><ul><li><a href=https://www.vaultproject.io/docs/internals/plugins>Vault Plugin System</a></li><li><a href=https://geth.ethereum.org/docs/interface/managing-your-accounts>Geth Managing Your Accounts</a></li><li><a href=https://lighthouse-book.sigmaprime.io/validator-web3signer.html>Remote Signing with Web3Signer</a></li><li><a href=https://learn.hashicorp.com/tutorials/vault/kubernetes-raft-deployment-guide>Vault on Kubernetes Deployment Guide</a></li><li><a href=https://github.com/hashicorp/vault-helm>Vault Helm Chart</a></li></ul><div class=blog-tags><a href=https://blog.rico.ninja/tags/hashicorp/>hashicorp</a>&nbsp;
<a href=https://blog.rico.ninja/tags/vault/>vault</a>&nbsp;
<a href=https://blog.rico.ninja/tags/ethereum/>ethereum</a>&nbsp;
<a href=https://blog.rico.ninja/tags/container/>container</a>&nbsp;
<a href=https://blog.rico.ninja/tags/kubernetes/>kubernetes</a>&nbsp;
<a href=https://blog.rico.ninja/tags/remote-signer/>remote-signer</a>&nbsp;</div><hr><section id=social-share><div class="list-inline footer-links"><div class=share-box aria-hidden=true><ul class=share><li><a href="//twitter.com/share?url=https%3a%2f%2fblog.rico.ninja%2fpost%2ftech%2fvault-ethereum%2f&text=Vault%20Ethereum%20Plugin&via=RicoChenNinja" target=_blank title="Share on Twitter"><i class="fab fa-twitter"></i></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.rico.ninja%2fpost%2ftech%2fvault-ethereum%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook"></i></a></li><li><a href="//reddit.com/submit?url=https%3a%2f%2fblog.rico.ninja%2fpost%2ftech%2fvault-ethereum%2f&title=Vault%20Ethereum%20Plugin" target=_blank title="Share on Reddit"><i class="fab fa-reddit"></i></a></li><li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fblog.rico.ninja%2fpost%2ftech%2fvault-ethereum%2f&title=Vault%20Ethereum%20Plugin" target=_blank title="Share on LinkedIn"><i class="fab fa-linkedin"></i></a></li><li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fblog.rico.ninja%2fpost%2ftech%2fvault-ethereum%2f&title=Vault%20Ethereum%20Plugin" target=_blank title="Share on StumbleUpon"><i class="fab fa-stumbleupon"></i></a></li><li><a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fblog.rico.ninja%2fpost%2ftech%2fvault-ethereum%2f&description=Vault%20Ethereum%20Plugin" target=_blank title="Share on Pinterest"><i class="fab fa-pinterest"></i></a></li></ul></div></div></section><h4 class=see-also>See also</h4><ul><li><a href=/post/tech/ecs-to-eks-3/>ECS migrate to EKS part 3</a></li><li><a href=/post/tech/ecs-to-eks-2/>ECS migrate to EKS part 2</a></li><li><a href=/post/tech/ecs-to-eks-1/>ECS migrate to EKS part 1</a></li></ul></article><ul class="pager blog-pager"><li class=previous><a href=https://blog.rico.ninja/post/tech/jenkins-jcasc/ data-toggle=tooltip data-placement=top title="Jenkins Configuration as Code (JCasC)">&larr; Previous Post</a></li><li class=next><a href=https://blog.rico.ninja/post/tech/pay-monero-for-the-mullvad-vpn/ data-toggle=tooltip data-placement=top title="Pay Monero for the Mullvad VPN">Next Post &rarr;</a></li></ul><div class=disqus-comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"rico-blog"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=mailto:rico3452@gmail.com title="Email me"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://github.com/RicoToothless title=GitHub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://twitter.com/RicoChenNinja title=Twitter><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fab fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://linkedin.com/in/rico-chen-devops title=LinkedIn><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://stackoverflow.com/users/10285171/ricochen title=StackOverflow><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted"><a href=blog.rico.ninja>Rico Chen</a>
&nbsp;&bull;&nbsp;&copy;
2022
&nbsp;&bull;&nbsp;
<a href=https://blog.rico.ninja>Rico-Blog</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.76.4</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous></script><script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script src=https://blog.rico.ninja/js/main.js></script><script src=https://blog.rico.ninja/js/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script><script>$(document).ready(function(){$("pre.chroma").css("padding","0");});</script><script>renderMathInElement(document.body);</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://blog.rico.ninja/js/load-photoswipe.js></script></body></html>